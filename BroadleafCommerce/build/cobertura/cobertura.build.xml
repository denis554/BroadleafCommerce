<?xml version="1.0" encoding="UTF-8"?>

<project name="BroadleafCommerce - Cobertura" default="instrument" basedir="../../">

	<property name="build.dir" value="${basedir}/build"/>
	<property name="stage.dir" value="${build.dir}/stage"/>
	<property name="lib.dir" value="${basedir}/lib"/>
	<property name="common.lib.dir" value="${lib.dir}/common" />
	<property name="cobertura.lib.dir" value="${lib.dir}/cobertura/bin"/>
	<property name="cobertura.instrumented.classes" value="${stage.dir}/instrumented-classes"/>

	<!-- All reports go into this directory -->
	<property name="reports.dir" value="${stage.dir}/cobertura_reports"/>

	<!--  Coverage reports are deposited into these directories -->
	<property name="coverage.xml.dir" value="${reports.dir}/cobertura-xml"/>
	<property name="coverage.summaryxml.dir" value="${reports.dir}/cobertura-summary-xml"/>
	<property name="coverage.html.dir" value="${reports.dir}/cobertura-html"/>

	<fileset id="cobertura.lib" dir="${cobertura.lib.dir}"
        description="cobertura dependencies">
		<include name="**/*.jar"/>
	</fileset>
	
	<path id="jars.dir">
		<fileset dir="${cobertura.lib.dir}">
			<include name="cobertura.jar"/>
		</fileset>
		<fileset dir="${lib.dir}">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<path id="common.lib">
		<fileset dir="${common.lib.dir}"
	        description="common dependencies">
			<include name="**/*.jar"/>
		</fileset>
	</path>
		
	<taskdef classpathref="jars.dir" resource="tasks.properties"/>

	<target name="init">
		<mkdir dir="${cobertura.instrumented.classes}" />
		<!-- mkdir dir="${reports.xml.dir}" / -->
		<!-- mkdir dir="${reports.html.dir}" / -->
		<mkdir dir="${coverage.xml.dir}" />
		<mkdir dir="${coverage.summaryxml.dir}" />
		<mkdir dir="${coverage.html.dir}" />
	</target>
	
	<target name="instrument" depends="clean, init">

		<cobertura-instrument todir="${cobertura.instrumented.classes}" datafile="${cobertura.instrumented.classes}/cobertura.ser" classpathref="common.lib">
			<ignore regex="org.apache.log4j.*" />
			
			<fileset dir="${stage.dir}">
				<exclude name="*test*.jar"/>
				<include name="broadleaf-auxiliary-web.jar" />
				<include name="broadleaf-auxiliary.jar" />
				<include name="broadleaf-framework-web.jar" />
				<include name="broadleaf-framework.jar" />
				<include name="broadleaf-layout.jar" />
				<include name="broadleaf-profile-web.jar" />
				<include name="broadleaf-profile.jar" />
			</fileset>
		</cobertura-instrument>
	</target>

	<target name="coverage-check">
		<cobertura-check branchrate="34" totallinerate="100" />
	</target>

	<target name="coverage-report">
		<!--
			Generate an XML file containing the coverage data using
			the "srcdir" attribute.
		-->
		<cobertura-report srcdir="${src.dir}" destdir="${coverage.xml.dir}" format="xml" />
	</target>

	<target name="summary-coverage-report">
		<!--
			Generate an summary XML file containing the coverage data using
			the "srcdir" attribute.
		-->
		<cobertura-report srcdir="${src.dir}" destdir="${coverage.summaryxml.dir}" format="summaryXml" />
	</target>

	<target name="alternate-coverage-report">
		<!--
			Generate a series of HTML files containing the coverage
			data in a user-readable form using nested source filesets.
		-->
		<cobertura-report destdir="${coverage.html.dir}">
			<fileset dir="${src.dir}">
				<include name="**/*.java"/>
			</fileset>
		</cobertura-report>
	</target>

	<target name="clean" description="Remove all files created by the build/test process.">
		<delete dir="${classes.dir}" />
		<delete dir="${cobertura.instrumented.classes}" />
		<delete dir="${reports.dir}" />
		<delete file="cobertura.log" />
		<delete file="cobertura.ser" />
	</target>

	<target name="reports.generate">
		<cobertura-report format="html" destdir="${reports.dir}" datafile="${cobertura.instrumented.classes}/cobertura.ser">
		    <fileset dir="src-auxiliary">
		        <include name="**/*.java" />
		        <exclude name="**/*.xml" />
		    </fileset>    		    
			<fileset dir="src-framework">
	        	<include name="**/*.java" />
	        	<exclude name="**/*.xml" />
	    	</fileset>
		    <fileset dir="src-layout">
		        <include name="**/*.java" />
		        <exclude name="**/*.xml" />
		    </fileset>    		    
			<fileset dir="src-profile">
	        	<include name="**/*.java" />
	        	<exclude name="**/*.xml" />
	    	</fileset>    			
		</cobertura-report>

	</target>
	
	<target name="coverage" depends="instrument,coverage-report,summary-coverage-report,alternate-coverage-report" description="Compile, instrument ourself, run the tests and generate JUnit and coverage reports."/>

</project>
