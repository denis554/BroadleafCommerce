<?xml version="1.0" encoding="UTF-8"?>
<project name="Broadleaf-modules-internal" default="usage" basedir="..">
	<description>
            Broadleaf Build File
    </description>
	
	<property name="stage.dir" value="${basedir}/build/stage" />
	<property name="lib.dir" value="${basedir}/lib" />
	<property name="compile.lib.dir" value="${lib.dir}/compile/bin" />
	<property name="common.lib.dir" value="${lib.dir}/common/bin" />
	<property name="test.output.dir" value="${basedir}/test-output" />
	<property file="${basedir}/build/build.properties" />
		
	<property name="modules.src.dir" value="${basedir}/src-modules" />
	<property name="modules.jar.dir" value="${stage.dir}/broadleaf-modules-jar" />
	<property name="modules.jar" value="${stage.dir}/broadleaf-modules.jar" />
	<property name="modules.src.jar" value="${stage.dir}/broadleaf-modules-sources.jar" />
	<property name="test.src.dir" value="${basedir}/src-modules-test" />
	<property name="schemas.jar" value="${stage.dir}/broadleaf-modules-schemas.jar" />
	<property name="schemas.src" value="${stage.dir}/broadleaf-modules-schemas" />

	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="${lib.dir}/test/bin/ant-contrib-1.0b3.jar" />
		</classpath>
	</taskdef>

	<fileset id="compile.lib" dir="${compile.lib.dir}" description="compile-time dependencies">
		<include name="**/*.jar" />
	</fileset>

	<fileset id="common.lib" dir="${common.lib.dir}" description="common dependencies">
		<include name="**/*.jar" />
	</fileset>
		
	<fileset id="stage.lib" dir="${stage.dir}">
		<include name="*.jar" />
	</fileset>
	
	<path id="modules-lib-path">
		<fileset refid="common.lib" />
	</path>
	
	<taskdef name="xmlbean" classname="org.apache.xmlbeans.impl.tool.XMLBean" classpathref="modules-lib-path"/>
	
	<target name="compile-modules-schemas">
		<mkdir dir="${schemas.src}" />	
		<xmlbean classgendir="${schemas.src}" classpathref="modules-lib-path">
			<fileset dir="${modules.src.dir}" includes="**/schema/*.xsd"/>
		</xmlbean>
	</target>
	
	<target name="package-modules-schemas" depends="compile-modules-schemas">
		<jar jarfile="${schemas.jar}">
			<fileset dir="${schemas.src}"/>
		</jar>
	</target>

	<target name="generate-javadocs">
		<mkdir dir="${stage.dir}/javadocs" />

		<path id="compile-lib">
			<fileset refid="compile.lib" />
			<fileset refid="common.lib" />
		</path>

		<javadoc packagenames="org.broadleafcommerce.*" destdir="${stage.dir}/javadoc-api" classpathref="compile-lib" useexternalfile="true">
			
		<fileset dir="${modules.src.dir}">
            <include name="**/*.java" />
         </fileset>
         
		</javadoc>
	</target>
	
	<target name="compile" depends="setup, package-modules-schemas">
		<mkdir dir="${modules.jar.dir}" />

		<path id="compile-lib">
			<fileset refid="compile.lib" />
			<fileset refid="common.lib" />
			<fileset refid="stage.lib" />
		</path>

		<echo>Compiling with debug=${debug.compile}</echo>
		<javac destdir="${modules.jar.dir}" srcdir="${modules.src.dir}" classpathref="compile-lib" debug="${debug.compile}"/>
	</target>

	<target name="build-jars" depends="compile">
		<copy todir="${modules.jar.dir}">
			<fileset dir="${modules.src.dir}">
				<include name="**/*.*" />
				<exclude name="**/*.java" />
			</fileset>
		</copy>

		<jar jarfile="${modules.jar}">
			<fileset dir="${modules.jar.dir}"/>
			<fileset dir="${schemas.src}"/>
		</jar>
	</target>

	<target name="build-source-jars">
		<delete file="${modules.src.jar}" />
		<jar jarfile="${modules.src.jar}" basedir="${modules.src.dir}">
			<include name="**/*.java" />
			<include name="**/*.properties" />
			<include name="**/*.txt" />
			<include name="**/*.xml" />
			<include name="**/*.vm" />
			<include name="**/*.mvel" />
			<include name="META-INF/**" />
			<exclude name="**/test/**/*.class" />
			<exclude name="**/web/**/*.*" />
		</jar>
	</target>

	<target name="clean">
		<delete dir="${stage.dir}" />
		<delete dir="${test.output.dir}" />
	</target>

	<target name="setup" depends="clean">
		<echo>Setting up for environment = ${build.env}</echo>
		<mkdir dir="${stage.dir}" />
		<if>
			<equals arg1="${build.env}" arg2="dev" />
			<then>
				<property name="debug.compile" value="true" />
			</then>
			<elseif>
				<equals arg1="${build.env}" arg2="unit-test" />
				<then>
					<property name="debug.compile" value="true" />
				</then>
			</elseif>
			<else>
				<property name="debug.compile" value="false" />
			</else>
		</if>

		<copy todir="${stage.dir}" file="${basedir}/../BroadleafCommerce/build/stage/broadleaf-profile.jar" />
		<copy todir="${stage.dir}" file="${basedir}/../BroadleafCommerce/build/stage/broadleaf-profile-web.jar" />
		<copy todir="${stage.dir}" file="${basedir}/../BroadleafCommerce/build/stage/broadleaf-framework.jar" />
		<copy todir="${stage.dir}" file="${basedir}/../BroadleafCommerce/build/stage/broadleaf-framework-web.jar" />
	</target>

	<target name="usage">
		<echo>
			This is an internal ANT build file.
			For development, use the targets in build.xml.
		</echo>
	</target>
</project>