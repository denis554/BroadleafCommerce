<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:p="http://www.springframework.org/schema/p" xmlns:sec="http://www.springframework.org/schema/security"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
                        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-2.0.2.xsd">


	<sec:http auto-config="true">
		<!-- sec:intercept-url pattern="/secure/extreme/**" access="ROLE_SUPERVISOR" />
		<sec:intercept-url pattern="/secure/**" access="ROLE_USER" />
		<sec:intercept-url pattern="/**" access="IS_AUTHENTICATED_ANONYMOUSLY" /-->
	</sec:http>
	
	<sec:authentication-manager alias="authManager"/>
	
	<sec:authentication-provider user-service-ref="userDetailsManager">
		<sec:password-encoder hash="plaintext"/>
	</sec:authentication-provider>
	
    <bean id="userDetailsManager" class="org.springframework.security.userdetails.jdbc.JdbcUserDetailsManager">
        <property name="dataSource" ref="webDS"/>
        <property name="authenticationManager" ref="authManager"/>
        <property name="enableGroups" value="false"/>
        <property name="enableAuthorities" value="true"/>
        <property name="usersByUsernameQuery" 
        	value="SELECT login AS username, password, 'true' as enabled FROM blc_admin_user WHERE login = ?"/>
        <property name="authoritiesByUsernameQuery" 
        	value="SELECT DISTINCT au.login AS username, ap.name AS authority FROM blc_admin_user au 
        		JOIN blc_admin_user_role_xref aurx ON au.admin_user_id = aurx.admin_user_id 
        		JOIN blc_admin_role ar ON aurx.admin_role_id = ar.admin_role_id 
        		JOIN blc_admin_role_permission_xref arpx ON ar.admin_role_id = arpx.admin_role_id 
        		JOIN blc_admin_permission ap ON arpx.admin_permission_id = ap.admin_permission_id 
        		WHERE au.login = ?"/>
	</bean>

	<!--
		===============================================================================================
	-->
	<!--
		Encode the passwords using ShaPasswordEncoder
	-->
	<!--
		===============================================================================================
	-->
	<bean id="passwordEncoder"
		class="org.springframework.security.providers.encoding.ShaPasswordEncoder" />

</beans>
